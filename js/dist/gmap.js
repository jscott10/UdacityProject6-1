/*! p5 2016-03-29 */
"use strict";var map,placesService,markerList=[],currentMarker,infoWindow,placeDetails,binghamton={lat:42.088848,lng:-75.969491},initMap=function(){google.maps.visualRefresh=!0;var a={center:binghamton,zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP},b=document.getElementById("map-div");map=new google.maps.Map(b,a);var c=new google.maps.TrafficLayer;c.setMap(map),infoWindow=new google.maps.InfoWindow({content:document.getElementById("info-window")}),placesService=new google.maps.places.PlacesService(map),initSystemState()},googleMapError=function(){$(".location-button").remove(),$("#map-div").append("<div class='google-map-error'></div>"),$(".google-map-error").append("<h2>Error loading Google Map</h2>"),$(".google-map-error").append("<p>Please try again later</p>")},initSystemState=function(){null!==localStorage.getItem("placeType")&&(placeType(localStorage.getItem("placeType")),getPlaces()),$("#place-type").selectmenu("refresh"),getAndDisplayYahooWeather()},setPlacesList=function(a,b){searchStatus(b),foundPlaces().length>0&&foundPlaces.removeAll(),b==google.maps.places.PlacesServiceStatus.OK&&(foundPlaces(a),addMarkers())},resetMapMarkers=function(){for(var a=0;a<markerList.length;a++)markerList[a].setMap(null),markerList[a]=null;markerList.length=0},addMarkers=function(){for(var a=0;a<filteredPlaces().length;a++)addMarker(filteredPlaces()[a],a)},addMarker=function(a,b){var c=new google.maps.Marker({place:{location:a.geometry.location,placeId:a.place_id},title:a.name,icon:{url:getMarkerIcon("inactive",b)},animation:google.maps.Animation.DROP,map:map});c.index=markerList.push(c)-1,c.addListener("click",function(){setCurrentMarker(c)})},setCurrentMarker=function(a){currentMarker&&(currentMarker.setIcon({url:getMarkerIcon("inactive",currentMarker.index)}),currentMarker.setAnimation(null)),currentMarker=a,map.setCenter(currentMarker.getPosition()),highlightMarker(currentMarker)},getCurrentMarker=function(a){for(var b=0;b<markerList.length;b++)if(a===markerList[b].getPlace().placeId)return markerList[b]},highlightMarker=function(a){a.setZIndex(google.maps.Marker.MAX_ZINDEX+1),a.setIcon({url:getMarkerIcon("active",a.index)}),a.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){a.setAnimation(null),openInfoWindow(a)},1500)},openInfoWindow=function(a){$("#info-window").empty(),$("#info-window").append("<p class='load-message'>Loading...</p>"),placesService.getDetails({placeId:a.getPlace().placeId},function(a,b){$("#info-window").empty(),b==google.maps.places.PlacesServiceStatus.OK?(self.placeDetails=a,displayPlaceInfo()):$("#info-window").append("<h3 class='no-review-message'>Could not load location info.</h3>")}),infoWindow.open(map,a)},displayPlaceInfo=function(){displayPlaceBanner(),$("#info-window").append("<h2>Reviews</h2>"),displayGoogleReviews(),getAndDisplayFoursquareReviews()},displayPlaceBanner=function(){if($("#info-window").append("<div class='info-banner' class='clearfix'></div>"),"undefined"!=typeof placeDetails.photos){var a=placeDetails.photos[0].getUrl({maxWidth:100});$(".info-banner").append("<img src='"+a+"' class='place-image'>")}$(".info-banner").append("<div class='banner-details'></div>"),"undefined"!=typeof placeDetails.name&&$(".banner-details").append("<h1>"+placeDetails.name+"</h1>"),"undefined"!=typeof placeDetails.formatted_address&&$(".banner-details").append("<p>"+placeDetails.formatted_address+"</p>"),"undefined"!=typeof placeDetails.formatted_phone_number&&$(".banner-details").append("<p>"+placeDetails.formatted_phone_number+"</p>")},displayGoogleReviews=function(){var a=placeDetails.reviews;if($("#info-window").append("<div class='google-reviews'></div>"),$(".google-reviews").append("<h3>Google</h3>"),"undefined"!=typeof a&&a.length>0){var b=function(){return a.sort(function(a,b){return a.time==b.time?0:a.time>b.time?-1:1})};$(".google-reviews").append("<ul></ul>");for(var c=b().length<4?b().length:4,d=0;c>d;d++)if(b()[d].text){var e=b()[d].text,f=b()[d].time;$(".google-reviews > ul").append("<li>"+e+" ("+formattedDateTime(f)+")</li>")}}else $(".google-reviews").append("<p class='no-review-message'>No reviews found.</p>")},getAndDisplayFoursquareReviews=function(){$("#info-window").append("<div class='foursquare-reviews'></div>"),$(".foursquare-reviews").append("<h3>FourSquare</h3>"),$(".foursquare-reviews").append("<p class='load-message'>Loading...</p>");var a="https://api.foursquare.com/v2/venues/search",b={client_id:"LKOCAAQC2EHG2YHBHPKMX2TAIHXEOXL3U2GQSCHN5542VYJE",client_secret:"QLLAGNKK2QOLH054PMAPYU1PUQQ4G3YNCOU52WBCH3HDKOQJ"},c={ll:placeDetails.geometry.location.lat()+", "+placeDetails.geometry.location.lng(),query:placeDetails.name,intent:"match",v:"20160101",m:"foursquare"};$.extend(c,b),$.getJSON(a,c,function(a){if(a.response.venues.length>0){var c=a.response.venues[0],d="https://api.foursquare.com/v2/venues/"+c.id,e={v:"20160101",m:"foursquare"};$.extend(e,b),$.getJSON(d,e,function(a){if(a.response.venue.tips.groups.length>0){var b=a.response.venue.tips.groups[0].items;displayFoursquareReviews(b)}else $(".foursquare-reviews > p.load-message").remove(),$(".foursquare-reviews").append("<p class='no-review-message'>No reviews found.</p>")}).fail(function(a,b){$(".foursquare-reviews > p.load-message").remove(),$(".foursquare-reviews").append("<p class='no-review-message'>Unable to retrieve Foursquare reviews.</p>")})}else $(".foursquare-reviews > p.load-message").remove(),$(".foursquare-reviews").append("<p class='no-review-message'>Foursquare venue not found.</p>")}).fail(function(){$(".foursquare-reviews > p.load-message").remove(),$(".foursquare-reviews").append("<p class='no-review-message'>Unable to retrieve Foursquare venue data.</p>")})},displayFoursquareReviews=function(a){if($(".foursquare-reviews > p.load-message").remove(),"undefined"!=typeof a&&a.length>0){var b=function(){return a.sort(function(a,b){return a.createdAt==b.createdAt?0:a.createdAt>b.createdAt?-1:1})};$(".foursquare-reviews").append("<ul></ul>");for(var c=b().length<4?b().length:4,d=0;c>d;d++)if(b()[d].text){var e=b()[d].text,f=b()[d].createdAt;$(".foursquare-reviews > ul").append("<li>"+e+" ("+formattedDateTime(f)+")</li>")}}else $(".foursquare-reviews").append("<p class='no-review-message'>No reviews found.</p>")},getAndDisplayYahooWeather=function(){var a="https://query.yahooapis.com/v1/public/yql",b={q:"select * from weather.forecast where woeid in (select woeid from geo.places(1) where text = 'Binghamton NY')",format:"json",env:"store://datatables.org:alltableswithkeys"};$.getJSON(a,b,function(a){displayYahooWeather(a)}).fail(function(){$(".yahoo-weather").remove()})},displayYahooWeather=function(a){var b=a.query.results.channel,c=b.description,d=b.item.condition,e="<img src='http://l.yimg.com/a/i/us/we/52/"+d.code+".gif'>",f=d.date,g=b.units,h=d.text+", "+d.temp+" "+g.temperature;$(".weather-banner").append("<strong>"+c+"</strong><br>"),$(".weather-banner").append(f),$(".current-conditions").append(e),$(".current-conditions").append("<span class='banner'>Current Conditions</span><br>"),$(".current-conditions").append("<span class='text'>"+h+"</span>")},getMarkerIcon=function(a,b){var c,d="ABCDEFGHIJKLMNOPQRSTUVWXYZ";switch(a){case"active":c="green";break;case"inactive":default:c="pink"}return"img/dist/gm-markers/"+c+"_Marker"+d[b]+".png"},formattedDateTime=function(a){var b=new Date(1e3*a),c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],d=b.getFullYear(),e=c[b.getMonth()],f=b.getDate(),g=f+" "+e+" "+d;return g};